version: '3.1'
services:
  app:
    image: node:10
    env_file:
    - .env.dev
    working_dir: /meltano/app
    volumes:
    - ./app:/meltano/app
    ports:
    - 8080:8080
    command: bash -c 'yarn && yarn run dev'
    depends_on:
    - api

  api:
    image: meltano/base
    env_file:
      - .env.dev
    working_dir: /meltano/packages
    command: ['python', '-m', 'api.app']
    volumes:
    - ./packages:/meltano/packages
    ports:
    - 5000:5000
    depends_on:
    - api_db

  api_db:
    image: postgres
    environment:
      POSTGRES_DB: meltano
      POSTGRES_PASSWORD: meltano
      POSTGRES_USER: meltano
    ports:
    - '5501:5432'
    volumes:
    - pgdata:/var/lib/postgresql/data

  warehouse_db:
    image: postgres
    environment:
      POSTGRES_DB: warehouse
      POSTGRES_PASSWORD: warehouse
      POSTGRES_USER: warehouse
    ports:
    - '5502:5432'

volumes:
  pgdata: